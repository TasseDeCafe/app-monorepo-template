import fs from 'node:fs/promises'
import path from 'node:path'
import { fileURLToPath } from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const SOURCE_DIR = path.join(__dirname, '../src/assets/frequency-lists')
const TARGET_DIR = path.join(__dirname, '../src/constants/frequency-lists')
const INDEX_FILENAME = 'index.ts'
const GENERATED_COMMENT =
  '// This file is auto-generated by scripts/convert-frequency-lists.js. Do not edit manually.\n'

const toCamelCase = (segments) => {
  if (segments.length === 0) {
    throw new Error('Cannot generate constant name from empty segments')
  }

  const [first, ...rest] = segments
  return (
    first.toLowerCase() +
    rest
      .map((segment) => {
        if (segment.length === 0) {
          return ''
        }
        return segment[0].toUpperCase() + segment.slice(1).toLowerCase()
      })
      .join('')
  )
}

const getConstNameForFile = (fileName) => {
  const baseName = fileName.replace(/\.txt$/i, '')
  const segments = baseName.split(/[_-]/g).filter(Boolean)
  const camelCase = toCamelCase(segments)
  return `${camelCase}FrequencyList`
}

const escapeWord = (word) => {
  return word.replace(/\\/g, '\\\\').replace(/'/g, "\\'")
}

const ensureTargetDir = async () => {
  await fs.mkdir(TARGET_DIR, { recursive: true })
}

const cleanTargetDir = async () => {
  try {
    const entries = await fs.readdir(TARGET_DIR, { withFileTypes: true })
    await Promise.all(
      entries
        .filter((entry) => entry.isFile() && entry.name.endsWith('.ts'))
        .map((entry) => fs.unlink(path.join(TARGET_DIR, entry.name)))
    )
  } catch (error) {
    if (error.code !== 'ENOENT') {
      throw error
    }
  }
}

const readSourceFiles = async () => {
  const entries = await fs.readdir(SOURCE_DIR, { withFileTypes: true })
  return entries.filter((entry) => entry.isFile() && entry.name.endsWith('.txt')).map((entry) => entry.name)
}

const buildFileContents = (words, constName, sourceName) => {
  const lines = words.map((word) => `  '${escapeWord(word)}',`)
  return `${GENERATED_COMMENT}// Source: ${sourceName}\n\nexport const ${constName}: readonly string[] = [\n${lines.join('\n')}\n]\n`
}

const buildIndexContents = (exportsMeta) => {
  const exportLines = exportsMeta
    .map(({ constName, tsFileName }) => `export { ${constName} } from './${tsFileName.replace(/\.ts$/, '')}'`)
    .join('\n')
  return `${GENERATED_COMMENT}\n${exportLines}\n`
}

const convertFile = async (fileName) => {
  const sourcePath = path.join(SOURCE_DIR, fileName)
  const content = await fs.readFile(sourcePath, 'utf-8')
  const words = content
    .split('\n')
    .map((word) => word.trim())
    .filter((word) => word.length > 0)

  if (words.length === 0) {
    console.warn(`Skipping ${fileName} because it does not contain any words`)
    return null
  }

  const constName = getConstNameForFile(fileName)
  const tsFileName = fileName.replace(/\.txt$/i, '.ts')
  const targetPath = path.join(TARGET_DIR, tsFileName)

  const fileContents = buildFileContents(words, constName, fileName)
  await fs.writeFile(targetPath, fileContents, 'utf-8')

  return { constName, tsFileName }
}

const main = async () => {
  try {
    await ensureTargetDir()
    await cleanTargetDir()

    const sourceFiles = await readSourceFiles()

    if (sourceFiles.length === 0) {
      console.warn(`No .txt files found in ${SOURCE_DIR}`)
      return
    }

    const exportsMetaPromises = sourceFiles
      .sort((a, b) => a.localeCompare(b))
      .map((fileName) => convertFile(fileName))

    const exportsMeta = (await Promise.all(exportsMetaPromises)).filter(Boolean)

    if (exportsMeta.length === 0) {
      console.warn('No frequency lists were converted.')
      return
    }

    const indexPath = path.join(TARGET_DIR, INDEX_FILENAME)
    const indexContents = buildIndexContents(exportsMeta)
    await fs.writeFile(indexPath, indexContents, 'utf-8')

    console.log(`Converted ${exportsMeta.length} frequency list${exportsMeta.length === 1 ? '' : 's'} to TypeScript.`)
    console.log(`Output directory: ${TARGET_DIR}`)
  } catch (error) {
    console.error('Failed to convert frequency lists:', error)
    process.exitCode = 1
  }
}

main()
